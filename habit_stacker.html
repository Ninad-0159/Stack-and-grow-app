<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker Lite</title>
    <!-- Load Tailwind CSS for simple styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        html { font-family: 'Inter', sans-serif; }
        .bg-app { background-color: #f3f4f6; } /* Light Gray Background */
        .bg-card { background-color: white; }
    </style>
</head>
<body class="bg-app min-h-screen p-4">

    <!-- Main Content Container -->
    <div class="max-w-md mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">My Habit Stacks</h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-1">Status: Connecting...</p>
        </header>

        <!-- Dynamic Status/Loading Area -->
        <div id="status-area" class="p-4 bg-yellow-100 text-yellow-700 rounded-lg shadow-md mb-6">
            Connecting to database...
        </div>

        <!-- 1. Generate New Stack -->
        <section id="stack-input-section" class="mb-8 hidden">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">1. Add New Stack (A â†’ B)</h2>
            <div class="bg-card p-4 rounded-lg shadow-lg space-y-3">
                <input type="text" id="habit-cue" placeholder="A: After I finish my coffee..." class="w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700" disabled>
                <input type="text" id="habit-action" placeholder="B: I will meditate for 5 minutes." class="w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700" disabled>
                <button onclick="saveNewHabit()" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition" disabled>
                    Add Habit Stack
                </button>
            </div>
        </section>

        <!-- 2. Daily Habit Checklist -->
        <section id="checklist-section" class="mb-8 hidden">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">2. Daily Habit Checklist</h2>
            <div id="habit-checklist" class="bg-card p-4 rounded-lg shadow-lg space-y-3">
                <p class="text-gray-500 text-center" id="checklist-message">Loading habits...</p>
            </div>
        </section>

    </div>

    <!-- Firebase Imports and Logic -->
    <script type="module">
        // --- Canvas Global Variables (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State ---
        let db = null;
        let auth = null;
        let userId = null;

        // --- UI Element References ---
        const statusArea = document.getElementById('status-area');
        const userIdDisplay = document.getElementById('user-id-display');
        const inputSection = document.getElementById('stack-input-section');
        const checklistSection = document.getElementById('checklist-section');
        const checklist = document.getElementById('habit-checklist');
        
        // --- Utility Functions ---
        const updateStatus = (message, isError = false) => {
            statusArea.textContent = message;
            statusArea.className = isError 
                ? 'p-4 bg-red-100 text-red-700 rounded-lg shadow-md mb-6' 
                : 'p-4 bg-green-100 text-green-700 rounded-lg shadow-md mb-6';
        };

        const toggleInputs = (enabled) => {
            const inputs = document.querySelectorAll('#stack-input-section input, #stack-input-section button');
            inputs.forEach(el => el.disabled = !enabled);
        };
        
        // --- Firebase Data Interaction ---

        function loadHabits() {
            if (!db || !userId) return;

            // Using Public data path: /artifacts/{appId}/public/data/habits
            const habitsColRef = collection(db, `artifacts/${appId}/public/data/habits`);
            const q = query(habitsColRef);

            onSnapshot(q, (snapshot) => {
                const habits = [];
                snapshot.forEach((doc) => {
                    habits.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by creation time
                habits.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                renderHabits(habits);
            }, (error) => {
                updateStatus(`Failed to fetch habits: ${error.message}`, true);
            });
        }

        window.saveNewHabit = async function() {
            if (!db || !userId) return updateStatus('Database not connected.', true);

            const cueInput = document.getElementById('habit-cue');
            const actionInput = document.getElementById('habit-action');
            const cue = cueInput.value.trim();
            const action = actionInput.value.trim();

            if (!cue || !action) return updateStatus('Please enter both cue and action.', true);

            try {
                const habitsColRef = collection(db, `artifacts/${appId}/public/data/habits`);
                
                await setDoc(doc(habitsColRef), {
                    userId: userId,
                    cue: cue,
                    action: action,
                    completedToday: false,
                    createdAt: Date.now()
                });

                cueInput.value = '';
                actionInput.value = '';
                updateStatus('Stack added successfully!', false);
            } catch (error) {
                updateStatus(`Failed to save habit: ${error.message}`, true);
            }
        }

        window.toggleHabitCompletion = async function(checkbox) {
            if (!db || !userId) return updateStatus('Database not connected.', true);

            const habitId = checkbox.dataset.habitId;
            const isChecked = checkbox.checked;

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/habits/${habitId}`);
                await setDoc(docRef, { completedToday: isChecked }, { merge: true });
            } catch (error) {
                updateStatus(`Failed to update habit: ${error.message}`, true);
                checkbox.checked = !isChecked; // Revert state on failure
            }
        }
        
        // --- UI Rendering ---

        function renderHabits(habits) {
            checklist.innerHTML = '';
            if (habits.length === 0) {
                checklist.innerHTML = `<p class="text-gray-500 text-center">No stacks yet. Use the section above to create one!</p>`;
                return;
            }

            habits.forEach(habit => {
                const checked = habit.completedToday ? 'checked' : '';
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 border-b';
                item.innerHTML = `
                    <div class="flex flex-col text-left">
                        <p class="text-xs text-gray-400">A: ${habit.cue}</p>
                        <p class="text-sm font-semibold text-gray-700">B: ${habit.action}</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" data-habit-id="${habit.id}" ${checked} class="sr-only peer" onchange="toggleHabitCompletion(this)">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                `;
                checklist.appendChild(item);
            });
        }


        // --- Initialization and Authentication ---

        async function initializeAppAndAuth() {
            try {
                // Initialize Firebase App and Services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Ensure session persistence
                await setPersistence(auth, browserSessionPersistence);

                // Sign in logic (using token if available, otherwise anonymous)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Handle Auth State Change
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // Show App Content
                        inputSection.classList.remove('hidden');
                        checklistSection.classList.remove('hidden');
                        
                        // Enable Inputs and start data sync
                        toggleInputs(true);
                        loadHabits();

                        // Update Status
                        userIdDisplay.textContent = `User ID: ${userId.substring(0, 8)}...`;
                        updateStatus('Connected and ready to track!', false);

                    } else {
                        // Failed or unauthenticated
                        userId = 'Auth Failed';
                        userIdDisplay.textContent = 'Status: Auth Failed';
                        updateStatus('Failed to authenticate. Please check the security rules.', true);
                    }
                });

            } catch (error) {
                updateStatus(`Initialization Error: ${error.message}`, true);
            }
        }

        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>

